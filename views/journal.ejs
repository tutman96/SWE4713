<%- include('partials/header') %>

<div class="title"><%= title %></div>
<% if (message) { %><div class="alert alert-info"><%= message %></div><% } %>
<div class="container">
	<div class="panel-body">
		<div class="form-horizontal">
			<div class="form-group">
				<label class="col-sm-2 control-label">Description</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" name="Description" value="<%=journal.Description%>">
				</div>
			</div>
			<div class="form-group">
				<div class="alert alert-danger" id="error" style="display:none"></div>
				<div class="col-sm-offset-2 col-sm-10 text-right">
					<% if (!isNew) { %>
						<% if (journal.Closed) { %>
							<button id="reopen" class="btn btn-warning pull-left" <%-(canBeOpened ? "" : "disabled")%>>Reopen</button>
						<% } else { %>
							<button id="close" class="btn btn-warning pull-left">Close</button>
						<% } %>
					<% } %>
					<button type="submit" id="save" class="btn btn-primary"><%=(isNew ? "Create" : "Save")%></button>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	var journal = <%-JSON.stringify(journal) %>;

	$("#save").click(function () {
		$("#error").hide();

		var formData = {
			JournalId: journal.JournalId,
			Description: $("input[name=Description]").val(),
			Closed: journal.Closed
		}

		$.ajax({
			method: "POST",
			url: "/journal/" + (journal.JournalId ? journal.JournalId : "new"),
			dataType: "json",
			data: formData,
			success: function () {
				if (journal.JournalId) location.reload()
				else if (journal.Closed) location.href = "/journals"
				else location.href = "/journal/current"
			},
			error: function (request, status, error) {
				console.error(error);
				$("#error").show().text(request.responseText);
			}
		})
	})

	// <% if (canBeOpened) { %>
	$("#reopen").click(function () {
		$("#error").hide();

		if (confirm("Are you sure you want to reopen " + journal.Description + "?")) {
			var formData = {
				JournalId: journal.JournalId,
				Description: journal.Description,
				Closed: false
			}

			$.ajax({
				method: "POST",
				url: "/journal/" + (journal.JournalId ? journal.JournalId : "new"),
				dataType: "json",
				data: formData,
				success: function () {
					location.href = "/journal/current";
				},
				error: function (request, status, error) {
					console.error(error);
					$("#error").show().text(request.responseText);
				}
			})
		}
	})
	// <% } %>
	
	// <% if (!journal.Closed) { %>
	$("#close").click(function () {
		$("#error").hide();

		if (confirm("Are you sure you want to close " + journal.Description + "? This will post all entries to their accounts.")) {
			var formData = {
				JournalId: journal.JournalId,
				Description: journal.Description,
				Closed: true
			}

			$.ajax({
				method: "POST",
				url: "/journal/" + journal.JournalId,
				dataType: "json",
				data: formData,
				success: function () {
					if (journal.JournalId) location.href = "/journal/" + journal.JournalId
					else location.href = "/journals";
				},
				error: function (request, status, error) {
					console.error(error);
					$("#error").show().text(request.responseText);
				}
			})
		}
	})
	// <% } %>

</script>

<%- include('partials/footer') %>